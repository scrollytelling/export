#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

if [ $# -eq 0 ]
then
	echo "This script exports an entire Scrollytelling account to HTML."
	echo "The export is dumped in HOME for your enjoyment. Don't swallow everything at once."
	echo
	echo "Pass the hostname you wish to export as paramater."
	echo "Usage: $0 <cname>"
	echo "  e.g. $0 stories.example.com"
	echo
	exit 1
fi

set -vx

# Bundler, for Ruby
gem install bundler --conservative
bundle check || bundle install

# Setup variables to use throughout the script.
HOSTNAME=$1

# STEP: query the database and build index.json
${HOME}/Rails/scrollytelling/bin/rails runner step_1_build_index/published_entries.rb $HOSTNAME

# STEP: download index.html to story folders.
step_1_build_index/canonical_urls $HOSTNAME \
	| parallel http --download --output ~/$HOSTNAME/{/}/original.html GET {}

# and the story-specific CSS
step_1_build_index/canonical_urls $HOSTNAME \
  | parallel http GET https://$HOSTNAME/entries/{/}.css \
	"|"ruby ~/export/step_1_build_index/replace.rb ">"~/$HOSTNAME/entries/{/}.css

# STEP: massage the HTML until it's fit for archiving.
parallel ruby ~/export/step_1_build_index/replace.rb \
	"<"{} ">"{//}/index.html ::: ~/$HOSTNAME/*/original.html

# STEP: sync media bucket
#   add --dryrun before the last quote to see what it will do
$HOME/export/step_1_build_index/media_folders $HOSTNAME \
	| parallel "aws s3 sync s3://{} ${HOME}/${HOSTNAME}/{}"

# STEP: sync output bucket. Bucket name is different from local path.
#   add --dryrun before the last quote to see what it will do
$HOME/export/step_1_build_index/output_folders $HOSTNAME \
	| parallel "aws s3 sync s3://storyboard-pageflow-production-out{} ${HOME}/${HOSTNAME}/output.scrollytelling.com{}"

# STEP: unpack static assets.
unzip $HOME/export/artifacts/assets.zip -d $HOME/$HOSTNAME/scrollytelling.link
unzip $HOME/export/artifacts/output.zip -d $HOME/$HOSTNAME/output.scrollytelling.com
unzip $HOME/export/artifacts/root.zip -d $HOME/$HOSTNAME

# STEP: make browser screenshots for each page of every story.
cd $HOME/scrollytelling-export/step_2_screenshots
bundle install
./grab $HOSTNAME
cd -

# unused?
# for file in entries/*; do
#   mv "$file" "scrollytelling.link/${file/\?*/}"
# done

# STEP: clean the html
find $HOME/$HOSTNAME \
  -type f \
	-exec sed -i 's\https://output.scrollytelling.io\/output.scrollytelling.com\g' {} +

find $HOME/$HOSTNAME \
  -type f \
	-exec sed -i 's\/media.scrollytelling\/media.scrollytelling\g' {} +

find $HOME/$HOSTNAME \
  -type f \
	-exec sed -i 's\/scrollytelling.link\/scrollytelling.link\g' {} +

# sed -i 's/ data-turbolinks-track="true"//g' */index.html # no turbolinks either
# sed -i 's/href="[a-z-]+\.html/href="/g' */index.html # no turbolinks either

# STEP: remove unwanted artifacts
rm robots.txt

# STEP: compile templates based on exported information.
cd step_3_account_index
# NPM, for Node
npm -v
npm install -g npm-check
npm-check

npm run mustache:all
